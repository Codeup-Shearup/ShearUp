<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <head th:replace="partials :: head (Title = 'View Barber Profile')">
        <meta charset="UTF-8">
        <title>Barber profile page</title>
            <meta class="map" th:content="${@environment.getProperty('map.api.key')}">
    </head>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
<!--Added script here, this is to download mapbox SDK-->
<script src="https://unpkg.com/@mapbox/mapbox-sdk/umd/mapbox-sdk.min.js"></script>
<style>
    body {
        background-color: #2B333D;
    }

    h1 {
        color: #FEFED3;
    }

    p {
        color: #FEFED3;
    }

    .card {
        background-color: #2B333D;
    }

    .card-text {
        color: #FEFED3;
    }

    .card-body {
        background-color: #2B333D;
    }

    .card-title {
        color: white;
    }

</style>

<header th:replace="partials :: header"></header>

<div class="container">
    <!--<h1>Barber Profile page of <p th:text="${user.firstName}"></p></h1>-->
    <h1>Welcome</h1>
    <h1 th:text="${user.firstName}">!</h1>
    <div class="card-deck">
        <!--  BIO NOT COMING OUT YET DEBUGGING POPULATES IN BIO IN BARBER DETAIL DATABASE  -->
        <div class="card border-danger rounded" style=" width: 19rem;">
            <div class="card-body">
                <h1 class="card-title">Bio: </h1><p class="card-text" th:text="${user.barberDetail.bio}"></p>
                <h1 class="card-title">Phone Number: </h1><p class="card-text" th:text="${user.barberDetail.phone}"></p>
                <h1 class="card-title">Hours of Operation: </h1><p class="card-text" th:text="${user.barberDetail.hoursOfWork}"></p>
                <form th:action="@{/barber/edit-barber-details}" th:method="get">
                    <input type="hidden" th:name="editBarberDetailsButton" th:value="${user.barberDetail.id}">
                    <button class="btn btn-primary">Edit Barber Details</button>
                </form>
            </div>
        </div>

        <div class="card border-danger rounded" style=" width: 19rem;">
            <h1 class="card-title">Location of Business: </h1>
            <div class="card-body">
                <!--  NOBODY TOUCH THIS IF YOU ARE CONFUSED CALL BRANCE -ERASE LATER  -->
                <h1 class="card-title">Address Line 1: </h1><p class="card-text" th:text="${user.barberDetail.location.addressOne}"></p>
                <p class="card-text" th:text="${user.barberDetail.location.addressTwo}"></p>
                <h1 class="card-title">City: </h1><p class="card-text" th:text="${user.barberDetail.location.city}"></p>
                <h1 class="card-title">State: </h1><p class="card-text" th:text="${user.barberDetail.location.state}"></p>
                <h1 class="card-title">Zipcode: </h1><p class="card-text" th:text="${user.barberDetail.location.zipCode}"></p>
                <form th:action="@{/barber/edit-barber-location}" th:method="get">
                    <input type="hidden" th:name="editLocationButton" th:value="${user.barberDetail.location.id}">
                    <button class="btn btn-primary">Edit Barber Location</button>
                </form>
            </div>
        </div>
    </div>
</div>
    <!--  THROWING ERROR FOR NOW WORKING ON FIX
    (I DID NOT WANT TO BREAK APPLICATION) -RAMON  -->
    <!--  TH EACH WORKS THE USER IN ${A WAY TO GET AROUND DATABASE}  -->

    <h1>
        List of Services
        <small class="text-muted">See below</small>
    </h1>
    <div class="card border border-danger rounded" style=" width: 19rem;" th:each="service : ${user.getBarberDetail().getServices()}">

        <!--   PICTURE OF SERVICE GOES HERE     -->
        <img class="card-image-top" src="..." alt="">
        <div class="card-body">
            <h5 class="card-title">Title: </h5><p class="card-text" th:text="${service.title}"></p>
            <h5 class ="card-title">Description: </h5><p class="card-text" th:text="${service.description}"></p>
            <h5 class="card-title">Duration: </h5><p class="card-text" th:text="${service.duration}"></p>
            <h5 class="card-title">Price: </h5><p class="card-text" th:text="${service.price}"></p>
        </div>
        <!--    <form th:action="@{/barber/service-delete}" th:method="post">-->
        <!--        <input type="hidden" th:name="deleteButton" th:value="${service.id}">-->
        <!--        <button class="btn btn-danger">Delete</button>-->
        <!--    </form>-->


        <form th:action="@{/barber/edit-service}" th:method="get">
            <input type="hidden" th:name="editButton" th:value="${service.id}">
            <button class="btn btn-primary">Edit Service</button>
        </form>
    </div>
    <!--  Added map-->
    <div id='map' style='width: 100%; height: 500px;'></div>
<!--    <div id='map' style='width: 400px; height: 300px;'></div>-->
    <!--  Added three spans below, display is none-->
    <span id="map_addr1" style="display: none;" th:text="${location.addressOne}"></span>
    <span id="map_city" style="display: none;" th:text="${location.city}"></span>
    <span id="map_state" style="display: none;" th:text="${location.state}"></span>
    <!--   Added the entire script below -->
    <script>
        // Change the accessToken to yours, use the applicaiton.properties to fetch the token
        const MAPBOX_KEY = document.querySelector('meta.map').content;
        mapboxgl.accessToken = MAPBOX_KEY;
        var mapboxClient = mapboxSdk({ accessToken: mapboxgl.accessToken });
        // Grabbed the three spans and assigned them to vars (spans come from the controller)
        var address = document.getElementById("map_addr1").innerHTML;
        var city = document.getElementById("map_city").innerHTML;
        var state = document.getElementById("map_state").innerHTML;
        // geocoded it (turned it into lat/long)
        mapboxClient.geocoding
            .forwardGeocode({
                query: address + "," + city + "," + state,
                autocomplete: false,
                limit: 1
            })
            // sent it to Mapbox SDK/API
            .send()
            // Take the response from API in form of JS promise
            .then(function(response) {
                // check if response is valid
                if (
                    response &&
                    response.body &&
                    response.body.features &&
                    response.body.features.length
                ) {
                    // if yes, grab the response (JSON) into a var
                    var feature = response.body.features[0];

                    // init the map object, pass in params
                    var map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/mapbox/dark-v10',
                        center: feature.center,
                        zoom: 10
                    });
                    // take the response var (feature) and set the lat and long .setLngLat()
                    // then add to map .addTo()
                    new mapboxgl.Marker().setLngLat(feature.center).addTo(map);
                }
            });

    </script>
</div>

<a th:href="@{/barber/add-service}"><button class="btn btn-success">Add Service</button></a>
</div>

</body>
</html>